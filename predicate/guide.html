<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="generator" content="Asciidoctor 0.1.4">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Predicate Guide</title>
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
article, aside, details, figcaption, figure, footer, header, hgroup, main, nav, section, summary { display: block; }
audio, canvas, video { display: inline-block; }
audio:not([controls]) { display: none; height: 0; }
[hidden] { display: none; }
html { background: #fff; color: #000; font-family: sans-serif; -ms-text-size-adjust: 100%; -webkit-text-size-adjust: 100%; }
body { margin: 0; }
a:focus { outline: thin dotted; }
a:active, a:hover { outline: 0; }
h1 { font-size: 2em; margin: 0.67em 0; }
abbr[title] { border-bottom: 1px dotted; }
b, strong { font-weight: bold; }
dfn { font-style: italic; }
hr { -moz-box-sizing: content-box; box-sizing: content-box; height: 0; }
mark { background: #ff0; color: #000; }
code, kbd, pre, samp { font-family: monospace, serif; font-size: 1em; }
pre { white-space: pre-wrap; }
q { quotes: "\201C" "\201D" "\2018" "\2019"; }
small { font-size: 80%; }
sub, sup { font-size: 75%; line-height: 0; position: relative; vertical-align: baseline; }
sup { top: -0.5em; }
sub { bottom: -0.25em; }
img { border: 0; }
svg:not(:root) { overflow: hidden; }
figure { margin: 0; }
fieldset { border: 1px solid #c0c0c0; margin: 0 2px; padding: 0.35em 0.625em 0.75em; }
legend { border: 0; padding: 0; }
button, input, select, textarea { font-family: inherit; font-size: 100%; margin: 0; }
button, input { line-height: normal; }
button, select { text-transform: none; }
button, html input[type="button"], input[type="reset"], input[type="submit"] { -webkit-appearance: button; cursor: pointer; }
button[disabled], html input[disabled] { cursor: default; }
input[type="checkbox"], input[type="radio"] { box-sizing: border-box; padding: 0; }
input[type="search"] { -webkit-appearance: textfield; -moz-box-sizing: content-box; -webkit-box-sizing: content-box; box-sizing: content-box; }
input[type="search"]::-webkit-search-cancel-button, input[type="search"]::-webkit-search-decoration { -webkit-appearance: none; }
button::-moz-focus-inner, input::-moz-focus-inner { border: 0; padding: 0; }
textarea { overflow: auto; vertical-align: top; }
table { border-collapse: collapse; border-spacing: 0; }
*, *:before, *:after { -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }
html, body { font-size: 100%; }
body { background: white; color: #222222; padding: 0; margin: 0; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: normal; font-style: normal; line-height: 1; position: relative; cursor: auto; }
a:hover { cursor: pointer; }
a:focus { outline: none; }
img, object, embed { max-width: 100%; height: auto; }
object, embed { height: 100%; }
img { -ms-interpolation-mode: bicubic; }
#map_canvas img, #map_canvas embed, #map_canvas object, .map_canvas img, .map_canvas embed, .map_canvas object { max-width: none !important; }
.left { float: left !important; }
.right { float: right !important; }
.text-left { text-align: left !important; }
.text-right { text-align: right !important; }
.text-center { text-align: center !important; }
.text-justify { text-align: justify !important; }
.hide { display: none; }
.antialiased, body { -webkit-font-smoothing: antialiased; }
img { display: inline-block; vertical-align: middle; }
textarea { height: auto; min-height: 50px; }
select { width: 100%; }
p.lead, .paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { font-size: 1.21875em; line-height: 1.6; }
.subheader, #content #toctitle, .admonitionblock td.content > .title, .exampleblock > .title, .imageblock > .title, .videoblock > .title, .listingblock > .title, .literalblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, .sidebarblock > .title, .tableblock > .title, .verseblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title, .tableblock > caption { line-height: 1.4; color: #7a2518; font-weight: 300; margin-top: 0.2em; margin-bottom: 0.5em; }
div, dl, dt, dd, ul, ol, li, h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6, pre, form, p, blockquote, th, td { margin: 0; padding: 0; direction: ltr; }
a { color: #005498; text-decoration: underline; line-height: inherit; }
a:hover, a:focus { color: #00467f; }
a img { border: none; }
p { font-family: inherit; font-weight: normal; font-size: 1em; line-height: 1.6; margin-bottom: 1.25em; text-rendering: optimizeLegibility; }
p aside { font-size: 0.875em; line-height: 1.35; font-style: italic; }
h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { font-family: Georgia, "URW Bookman L", Helvetica, Arial, sans-serif; font-weight: normal; font-style: normal; color: #ba3925; text-rendering: optimizeLegibility; margin-top: 1em; margin-bottom: 0.5em; line-height: 1.2125em; }
h1 small, h2 small, h3 small, #toctitle small, .sidebarblock > .content > .title small, h4 small, h5 small, h6 small { font-size: 60%; color: #e99b8f; line-height: 0; }
h1 { font-size: 2.125em; }
h2 { font-size: 1.6875em; }
h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.375em; }
h4 { font-size: 1.125em; }
h5 { font-size: 1.125em; }
h6 { font-size: 1em; }
hr { border: solid #dddddd; border-width: 1px 0 0; clear: both; margin: 1.25em 0 1.1875em; height: 0; }
em, i { font-style: italic; line-height: inherit; }
strong, b { font-weight: bold; line-height: inherit; }
small { font-size: 60%; line-height: inherit; }
code { font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: normal; color: #6d180b; }
ul, ol, dl { font-size: 1em; line-height: 1.6; margin-bottom: 1.25em; list-style-position: outside; font-family: inherit; }
ul, ol { margin-left: 1.5em; }
ul li ul, ul li ol { margin-left: 1.25em; margin-bottom: 0; font-size: 1em; }
ul.square li ul, ul.circle li ul, ul.disc li ul { list-style: inherit; }
ul.square { list-style-type: square; }
ul.circle { list-style-type: circle; }
ul.disc { list-style-type: disc; }
ul.no-bullet { list-style: none; }
ol li ul, ol li ol { margin-left: 1.25em; margin-bottom: 0; }
dl dt { margin-bottom: 0.3125em; font-weight: bold; }
dl dd { margin-bottom: 1.25em; }
abbr, acronym { text-transform: uppercase; font-size: 90%; color: #222222; border-bottom: 1px dotted #dddddd; cursor: help; }
abbr { text-transform: none; }
blockquote { margin: 0 0 1.25em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #dddddd; }
blockquote cite { display: block; font-size: inherit; color: #555555; }
blockquote cite:before { content: "\2014 \0020"; }
blockquote cite a, blockquote cite a:visited { color: #555555; }
blockquote, blockquote p { line-height: 1.6; color: #6f6f6f; }
.vcard { display: inline-block; margin: 0 0 1.25em 0; border: 1px solid #dddddd; padding: 0.625em 0.75em; }
.vcard li { margin: 0; display: block; }
.vcard .fn { font-weight: bold; font-size: 0.9375em; }
.vevent .summary { font-weight: bold; }
.vevent abbr { cursor: auto; text-decoration: none; font-weight: bold; border: none; padding: 0 0.0625em; }
@media only screen and (min-width: 768px) { h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; }
  h1 { font-size: 2.75em; }
  h2 { font-size: 2.3125em; }
  h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.6875em; }
  h4 { font-size: 1.4375em; } }
.print-only { display: none !important; }
@media print { * { background: transparent !important; color: #000 !important; box-shadow: none !important; text-shadow: none !important; }
  a, a:visited { text-decoration: underline; }
  a[href]:after { content: " (" attr(href) ")"; }
  abbr[title]:after { content: " (" attr(title) ")"; }
  .ir a:after, a[href^="javascript:"]:after, a[href^="#"]:after { content: ""; }
  pre, blockquote { border: 1px solid #999; page-break-inside: avoid; }
  thead { display: table-header-group; }
  tr, img { page-break-inside: avoid; }
  img { max-width: 100% !important; }
  @page { margin: 0.5cm; }
  p, h2, h3, #toctitle, .sidebarblock > .content > .title { orphans: 3; widows: 3; }
  h2, h3, #toctitle, .sidebarblock > .content > .title { page-break-after: avoid; }
  .hide-on-print { display: none !important; }
  .print-only { display: block !important; }
  .hide-for-print { display: none !important; }
  .show-for-print { display: inherit !important; } }
table { background: white; margin-bottom: 1.25em; border: solid 1px #dddddd; }
table thead, table tfoot { background: whitesmoke; font-weight: bold; }
table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td { padding: 0.5em 0.625em 0.625em; font-size: inherit; color: #222222; text-align: left; }
table tr th, table tr td { padding: 0.5625em 0.625em; font-size: inherit; color: #222222; }
table tr.even, table tr.alt, table tr:nth-of-type(even) { background: #f9f9f9; }
table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td { display: table-cell; line-height: 1.6; }
.clearfix:before, .clearfix:after, .float-group:before, .float-group:after { content: " "; display: table; }
.clearfix:after, .float-group:after { clear: both; }
*:not(pre) > code { font-size: 0.9375em; padding: 1px 3px 0; white-space: nowrap; background-color: #f2f2f2; border: 1px solid #cccccc; -webkit-border-radius: 4px; border-radius: 4px; text-shadow: none; }
pre, pre > code { line-height: 1.4; color: inherit; font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: normal; }
kbd.keyseq { color: #555555; }
kbd:not(.keyseq) { display: inline-block; color: #222222; font-size: 0.75em; line-height: 1.4; background-color: #F7F7F7; border: 1px solid #ccc; -webkit-border-radius: 3px; border-radius: 3px; -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 2px white inset; box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 2px white inset; margin: -0.15em 0.15em 0 0.15em; padding: 0.2em 0.6em 0.2em 0.5em; vertical-align: middle; white-space: nowrap; }
kbd kbd:first-child { margin-left: 0; }
kbd kbd:last-child { margin-right: 0; }
.menuseq, .menu { color: #090909; }
p a > code:hover { color: #561309; }
#header, #content, #footnotes, #footer { width: 100%; margin-left: auto; margin-right: auto; margin-top: 0; margin-bottom: 0; max-width: 62.5em; *zoom: 1; position: relative; padding-left: 0.9375em; padding-right: 0.9375em; }
#header:before, #header:after, #content:before, #content:after, #footnotes:before, #footnotes:after, #footer:before, #footer:after { content: " "; display: table; }
#header:after, #content:after, #footnotes:after, #footer:after { clear: both; }
#header { margin-bottom: 2.5em; }
#header > h1 { color: black; font-weight: normal; border-bottom: 1px solid #dddddd; margin-bottom: -28px; padding-bottom: 32px; }
#header span { color: #6f6f6f; }
#header #revnumber { text-transform: capitalize; }
#header br { display: none; }
#header br + span { padding-left: 3px; }
#header br + span:before { content: "\2013 \0020"; }
#header br + span.author { padding-left: 0; }
#header br + span.author:before { content: ", "; }
#toc { border-bottom: 3px double #ebebeb; padding-bottom: 1.25em; }
#toc > ul { margin-left: 0.25em; }
#toc ul.sectlevel0 > li > a { font-style: italic; }
#toc ul.sectlevel0 ul.sectlevel1 { margin-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
#toc ul { list-style-type: none; }
#toctitle { color: #7a2518; }
@media only screen and (min-width: 1280px) { body.toc2 { padding-left: 20em; }
  #toc.toc2 { position: fixed; width: 20em; left: 0; top: 0; border-right: 1px solid #ebebeb; border-bottom: 0; z-index: 1000; padding: 1em; height: 100%; overflow: auto; }
  #toc.toc2 #toctitle { margin-top: 0; }
  #toc.toc2 > ul { font-size: .95em; }
  #toc.toc2 ul ul { margin-left: 0; padding-left: 1.25em; }
  #toc.toc2 ul.sectlevel0 ul.sectlevel1 { padding-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 20em; }
  body.toc2.toc-right #toc.toc2 { border-right: 0; border-left: 1px solid #ebebeb; left: auto; right: 0; } }
#content #toc { border-style: solid; border-width: 1px; border-color: #d9d9d9; margin-bottom: 1.25em; padding: 1.25em; background: #f2f2f2; border-width: 0; -webkit-border-radius: 4px; border-radius: 4px; }
#content #toc > :first-child { margin-top: 0; }
#content #toc > :last-child { margin-bottom: 0; }
#content #toc a { text-decoration: none; }
#content #toctitle { font-weight: bold; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-size: 1em; padding-left: 0.125em; }
#footer { max-width: 100%; background-color: #222222; padding: 1.25em; }
#footer-text { color: #dddddd; line-height: 1.44; }
.sect1 { padding-bottom: 1.25em; }
.sect1 + .sect1 { border-top: 3px double #ebebeb; }
#content h1 > a.anchor, h2 > a.anchor, h3 > a.anchor, #toctitle > a.anchor, .sidebarblock > .content > .title > a.anchor, h4 > a.anchor, h5 > a.anchor, h6 > a.anchor { position: absolute; width: 1em; margin-left: -1em; display: block; text-decoration: none; visibility: hidden; text-align: center; font-weight: normal; }
#content h1 > a.anchor:before, h2 > a.anchor:before, h3 > a.anchor:before, #toctitle > a.anchor:before, .sidebarblock > .content > .title > a.anchor:before, h4 > a.anchor:before, h5 > a.anchor:before, h6 > a.anchor:before { content: '\00A7'; font-size: .85em; vertical-align: text-top; display: block; margin-top: 0.05em; }
#content h1:hover > a.anchor, #content h1 > a.anchor:hover, h2:hover > a.anchor, h2 > a.anchor:hover, h3:hover > a.anchor, #toctitle:hover > a.anchor, .sidebarblock > .content > .title:hover > a.anchor, h3 > a.anchor:hover, #toctitle > a.anchor:hover, .sidebarblock > .content > .title > a.anchor:hover, h4:hover > a.anchor, h4 > a.anchor:hover, h5:hover > a.anchor, h5 > a.anchor:hover, h6:hover > a.anchor, h6 > a.anchor:hover { visibility: visible; }
#content h1 > a.link, h2 > a.link, h3 > a.link, #toctitle > a.link, .sidebarblock > .content > .title > a.link, h4 > a.link, h5 > a.link, h6 > a.link { color: #ba3925; text-decoration: none; }
#content h1 > a.link:hover, h2 > a.link:hover, h3 > a.link:hover, #toctitle > a.link:hover, .sidebarblock > .content > .title > a.link:hover, h4 > a.link:hover, h5 > a.link:hover, h6 > a.link:hover { color: #a53221; }
.imageblock, .literalblock, .listingblock, .verseblock, .videoblock { margin-bottom: 1.25em; }
.admonitionblock td.content > .title, .exampleblock > .title, .imageblock > .title, .videoblock > .title, .listingblock > .title, .literalblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, .sidebarblock > .title, .tableblock > .title, .verseblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { text-align: left; font-weight: bold; }
.tableblock > caption { text-align: left; font-weight: bold; white-space: nowrap; overflow: visible; max-width: 0; }
table.tableblock #preamble > .sectionbody > .paragraph:first-of-type p { font-size: inherit; }
.admonitionblock > table { border: 0; background: none; width: 100%; }
.admonitionblock > table td.icon { text-align: center; width: 80px; }
.admonitionblock > table td.icon img { max-width: none; }
.admonitionblock > table td.icon .title { font-weight: bold; text-transform: uppercase; }
.admonitionblock > table td.content { padding-left: 1.125em; padding-right: 1.25em; border-left: 1px solid #dddddd; color: #6f6f6f; }
.admonitionblock > table td.content > :last-child > :last-child { margin-bottom: 0; }
.exampleblock > .content { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.25em; padding: 1.25em; background: white; -webkit-border-radius: 4px; border-radius: 4px; }
.exampleblock > .content > :first-child { margin-top: 0; }
.exampleblock > .content > :last-child { margin-bottom: 0; }
.exampleblock > .content h1, .exampleblock > .content h2, .exampleblock > .content h3, .exampleblock > .content #toctitle, .sidebarblock.exampleblock > .content > .title, .exampleblock > .content h4, .exampleblock > .content h5, .exampleblock > .content h6, .exampleblock > .content p { color: #333333; }
.exampleblock > .content h1, .exampleblock > .content h2, .exampleblock > .content h3, .exampleblock > .content #toctitle, .sidebarblock.exampleblock > .content > .title, .exampleblock > .content h4, .exampleblock > .content h5, .exampleblock > .content h6 { line-height: 1; margin-bottom: 0.625em; }
.exampleblock > .content h1.subheader, .exampleblock > .content h2.subheader, .exampleblock > .content h3.subheader, .exampleblock > .content .subheader#toctitle, .sidebarblock.exampleblock > .content > .subheader.title, .exampleblock > .content h4.subheader, .exampleblock > .content h5.subheader, .exampleblock > .content h6.subheader { line-height: 1.4; }
.exampleblock.result > .content { -webkit-box-shadow: 0 1px 8px #d9d9d9; box-shadow: 0 1px 8px #d9d9d9; }
.sidebarblock { border-style: solid; border-width: 1px; border-color: #d9d9d9; margin-bottom: 1.25em; padding: 1.25em; background: #f2f2f2; -webkit-border-radius: 4px; border-radius: 4px; }
.sidebarblock > :first-child { margin-top: 0; }
.sidebarblock > :last-child { margin-bottom: 0; }
.sidebarblock h1, .sidebarblock h2, .sidebarblock h3, .sidebarblock #toctitle, .sidebarblock > .content > .title, .sidebarblock h4, .sidebarblock h5, .sidebarblock h6, .sidebarblock p { color: #333333; }
.sidebarblock h1, .sidebarblock h2, .sidebarblock h3, .sidebarblock #toctitle, .sidebarblock > .content > .title, .sidebarblock h4, .sidebarblock h5, .sidebarblock h6 { line-height: 1; margin-bottom: 0.625em; }
.sidebarblock h1.subheader, .sidebarblock h2.subheader, .sidebarblock h3.subheader, .sidebarblock .subheader#toctitle, .sidebarblock > .content > .subheader.title, .sidebarblock h4.subheader, .sidebarblock h5.subheader, .sidebarblock h6.subheader { line-height: 1.4; }
.sidebarblock > .content > .title { color: #7a2518; margin-top: 0; line-height: 1.6; }
.exampleblock > .content > :last-child > :last-child, .exampleblock > .content .olist > ol > li:last-child > :last-child, .exampleblock > .content .ulist > ul > li:last-child > :last-child, .exampleblock > .content .qlist > ol > li:last-child > :last-child, .sidebarblock > .content > :last-child > :last-child, .sidebarblock > .content .olist > ol > li:last-child > :last-child, .sidebarblock > .content .ulist > ul > li:last-child > :last-child, .sidebarblock > .content .qlist > ol > li:last-child > :last-child { margin-bottom: 0; }
.literalblock > .content pre, .listingblock > .content pre { background: none; border-width: 1px 0; border-style: dotted; border-color: #bfbfbf; -webkit-border-radius: 4px; border-radius: 4px; padding: 0.75em 0.75em 0.5em 0.75em; word-wrap: break-word; }
.literalblock > .content pre.nowrap, .listingblock > .content pre.nowrap { overflow-x: auto; white-space: pre; word-wrap: normal; }
.literalblock > .content pre > code, .listingblock > .content pre > code { display: block; }
@media only screen { .literalblock > .content pre, .listingblock > .content pre { font-size: 0.8em; } }
@media only screen and (min-width: 768px) { .literalblock > .content pre, .listingblock > .content pre { font-size: 0.9em; } }
@media only screen and (min-width: 1280px) { .literalblock > .content pre, .listingblock > .content pre { font-size: 1em; } }
.listingblock > .content { position: relative; }
.listingblock:hover code[class*=" language-"]:before { text-transform: uppercase; font-size: 0.9em; color: #999; position: absolute; top: 0.375em; right: 0.375em; }
.listingblock:hover code.asciidoc:before { content: "asciidoc"; }
.listingblock:hover code.clojure:before { content: "clojure"; }
.listingblock:hover code.css:before { content: "css"; }
.listingblock:hover code.groovy:before { content: "groovy"; }
.listingblock:hover code.html:before { content: "html"; }
.listingblock:hover code.java:before { content: "java"; }
.listingblock:hover code.javascript:before { content: "javascript"; }
.listingblock:hover code.python:before { content: "python"; }
.listingblock:hover code.ruby:before { content: "ruby"; }
.listingblock:hover code.scss:before { content: "scss"; }
.listingblock:hover code.xml:before { content: "xml"; }
.listingblock:hover code.yaml:before { content: "yaml"; }
.listingblock.terminal pre .command:before { content: attr(data-prompt); padding-right: 0.5em; color: #999; }
.listingblock.terminal pre .command:not([data-prompt]):before { content: '$'; }
table.pyhltable { border: 0; margin-bottom: 0; }
table.pyhltable td { vertical-align: top; padding-top: 0; padding-bottom: 0; }
table.pyhltable td.code { padding-left: .75em; padding-right: 0; }
.highlight.pygments .lineno, table.pyhltable td:not(.code) { color: #999; padding-left: 0; padding-right: .5em; border-right: 1px solid #dddddd; }
.highlight.pygments .lineno { display: inline-block; margin-right: .25em; }
table.pyhltable .linenodiv { background-color: transparent !important; padding-right: 0 !important; }
.quoteblock { margin: 0 0 1.25em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #dddddd; }
.quoteblock blockquote { margin: 0 0 1.25em 0; padding: 0 0 0.5625em 0; border: 0; }
.quoteblock blockquote > .paragraph:last-child p { margin-bottom: 0; }
.quoteblock .attribution { margin-top: -.25em; padding-bottom: 0.5625em; font-size: inherit; color: #555555; }
.quoteblock .attribution br { display: none; }
.quoteblock .attribution cite { display: block; margin-bottom: 0.625em; }
table thead th, table tfoot th { font-weight: bold; }
table.tableblock.grid-all { border-collapse: separate; border-spacing: 1px; -webkit-border-radius: 4px; border-radius: 4px; border-top: 1px solid #dddddd; border-bottom: 1px solid #dddddd; }
table.tableblock.frame-topbot, table.tableblock.frame-none { border-left: 0; border-right: 0; }
table.tableblock.frame-sides, table.tableblock.frame-none { border-top: 0; border-bottom: 0; }
table.tableblock td .paragraph:last-child p, table.tableblock td > p:last-child { margin-bottom: 0; }
th.tableblock.halign-left, td.tableblock.halign-left { text-align: left; }
th.tableblock.halign-right, td.tableblock.halign-right { text-align: right; }
th.tableblock.halign-center, td.tableblock.halign-center { text-align: center; }
th.tableblock.valign-top, td.tableblock.valign-top { vertical-align: top; }
th.tableblock.valign-bottom, td.tableblock.valign-bottom { vertical-align: bottom; }
th.tableblock.valign-middle, td.tableblock.valign-middle { vertical-align: middle; }
p.tableblock.header { color: #222222; font-weight: bold; }
td > div.verse { white-space: pre; }
ol { margin-left: 1.75em; }
ul li ol { margin-left: 1.5em; }
dl dd { margin-left: 1.125em; }
dl dd:last-child, dl dd:last-child > :last-child { margin-bottom: 0; }
ol > li p, ul > li p, ul dd, ol dd, .olist .olist, .ulist .ulist, .ulist .olist, .olist .ulist { margin-bottom: 0.625em; }
ul.unstyled, ol.unnumbered, ul.checklist, ul.none { list-style-type: none; }
ul.unstyled, ol.unnumbered, ul.checklist { margin-left: 0.625em; }
ul.checklist li > p:first-child > i[class^="icon-check"]:first-child, ul.checklist li > p:first-child > input[type="checkbox"]:first-child { margin-right: 0.25em; }
ul.checklist li > p:first-child > input[type="checkbox"]:first-child { position: relative; top: 1px; }
ul.inline { margin: 0 auto 0.625em auto; margin-left: -1.375em; margin-right: 0; padding: 0; list-style: none; overflow: hidden; }
ul.inline > li { list-style: none; float: left; margin-left: 1.375em; display: block; }
ul.inline > li > * { display: block; }
.unstyled dl dt { font-weight: normal; font-style: normal; }
ol.arabic { list-style-type: decimal; }
ol.decimal { list-style-type: decimal-leading-zero; }
ol.loweralpha { list-style-type: lower-alpha; }
ol.upperalpha { list-style-type: upper-alpha; }
ol.lowerroman { list-style-type: lower-roman; }
ol.upperroman { list-style-type: upper-roman; }
ol.lowergreek { list-style-type: lower-greek; }
.hdlist > table, .colist > table { border: 0; background: none; }
.hdlist > table > tbody > tr, .colist > table > tbody > tr { background: none; }
td.hdlist1 { padding-right: .8em; font-weight: bold; }
td.hdlist1, td.hdlist2 { vertical-align: top; }
.literalblock + .colist, .listingblock + .colist { margin-top: -0.5em; }
.colist > table tr > td:first-of-type { padding: 0 .8em; line-height: 1; }
.colist > table tr > td:last-of-type { padding: 0.25em 0; }
.qanda > ol > li > p > em:only-child { color: #00467f; }
.thumb, .th { line-height: 0; display: inline-block; border: solid 4px white; -webkit-box-shadow: 0 0 0 1px #dddddd; box-shadow: 0 0 0 1px #dddddd; }
.imageblock.left, .imageblock[style*="float: left"] { margin: 0.25em 0.625em 1.25em 0; }
.imageblock.right, .imageblock[style*="float: right"] { margin: 0.25em 0 1.25em 0.625em; }
.imageblock > .title { margin-bottom: 0; }
.imageblock.thumb, .imageblock.th { border-width: 6px; }
.imageblock.thumb > .title, .imageblock.th > .title { padding: 0 0.125em; }
.image.left, .image.right { margin-top: 0.25em; margin-bottom: 0.25em; display: inline-block; line-height: 0; }
.image.left { margin-right: 0.625em; }
.image.right { margin-left: 0.625em; }
a.image { text-decoration: none; }
span.footnote, span.footnoteref { vertical-align: super; font-size: 0.875em; }
span.footnote a, span.footnoteref a { text-decoration: none; }
#footnotes { padding-top: 0.75em; padding-bottom: 0.75em; margin-bottom: 0.625em; }
#footnotes hr { width: 20%; min-width: 6.25em; margin: -.25em 0 .75em 0; border-width: 1px 0 0 0; }
#footnotes .footnote { padding: 0 0.375em; line-height: 1.3; font-size: 0.875em; margin-left: 1.2em; text-indent: -1.2em; margin-bottom: .2em; }
#footnotes .footnote a:first-of-type { font-weight: bold; text-decoration: none; }
#footnotes .footnote:last-of-type { margin-bottom: 0; }
#content #footnotes { margin-top: -0.625em; margin-bottom: 0; padding: 0.75em 0; }
.gist .file-data > table { border: none; background: #fff; width: 100%; margin-bottom: 0; }
.gist .file-data > table td.line-data { width: 99%; }
div.unbreakable { page-break-inside: avoid; }
.big { font-size: larger; }
.small { font-size: smaller; }
.underline { text-decoration: underline; }
.overline { text-decoration: overline; }
.line-through { text-decoration: line-through; }
.aqua { color: #00bfbf; }
.aqua-background { background-color: #00fafa; }
.black { color: black; }
.black-background { background-color: black; }
.blue { color: #0000bf; }
.blue-background { background-color: #0000fa; }
.fuchsia { color: #bf00bf; }
.fuchsia-background { background-color: #fa00fa; }
.gray { color: #606060; }
.gray-background { background-color: #7d7d7d; }
.green { color: #006000; }
.green-background { background-color: #007d00; }
.lime { color: #00bf00; }
.lime-background { background-color: #00fa00; }
.maroon { color: #600000; }
.maroon-background { background-color: #7d0000; }
.navy { color: #000060; }
.navy-background { background-color: #00007d; }
.olive { color: #606000; }
.olive-background { background-color: #7d7d00; }
.purple { color: #600060; }
.purple-background { background-color: #7d007d; }
.red { color: #bf0000; }
.red-background { background-color: #fa0000; }
.silver { color: #909090; }
.silver-background { background-color: #bcbcbc; }
.teal { color: #006060; }
.teal-background { background-color: #007d7d; }
.white { color: #bfbfbf; }
.white-background { background-color: #fafafa; }
.yellow { color: #bfbf00; }
.yellow-background { background-color: #fafa00; }
span.icon > [class^="icon-"], span.icon > [class*=" icon-"] { cursor: default; }
.admonitionblock td.icon [class^="icon-"]:before { font-size: 2.5em; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); cursor: default; }
.admonitionblock td.icon .icon-note:before { content: "\f05a"; color: #005498; color: #003f72; }
.admonitionblock td.icon .icon-tip:before { content: "\f0eb"; text-shadow: 1px 1px 2px rgba(155, 155, 0, 0.8); color: #111; }
.admonitionblock td.icon .icon-warning:before { content: "\f071"; color: #bf6900; }
.admonitionblock td.icon .icon-caution:before { content: "\f06d"; color: #bf3400; }
.admonitionblock td.icon .icon-important:before { content: "\f06a"; color: #bf0000; }
.conum { display: inline-block; color: white !important; background-color: #222222; -webkit-border-radius: 100px; border-radius: 100px; text-align: center; width: 20px; height: 20px; font-size: 12px; font-weight: bold; line-height: 20px; font-family: Arial, sans-serif; font-style: normal; position: relative; top: -2px; letter-spacing: -1px; }
.conum * { color: white !important; }
.conum + b { display: none; }
.conum:after { content: attr(data-value); }
.conum:not([data-value]):empty { display: none; }
.literalblock > .content > pre, .listingblock > .content > pre { -webkit-border-radius: 0; border-radius: 0; }

</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Predicate Guide</h1>
<span id="author" class="author">Christopher Alfeld</span><br>
<span id="email" class="email"><a href="mailto:calfeld@qualys.com">calfeld@qualys.com</a></span><br>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_introduction">Introduction</a></li>
<li><a href="#_orientation">Orientation</a></li>
<li>
<ul class="sectlevel2">
<li><a href="#_terminology">Terminology</a></li>
<li><a href="#_first_steps">First Steps</a></li>
<li><a href="#_second_steps">Second Steps</a></li>
<li><a href="#s.composition">Composition</a></li>
<li><a href="#_configuration_time">Configuration Time</a></li>
<li><a href="#_expressions_and_the_dag">Expressions and the DAG</a></li>
<li><a href="#_values">Values</a></li>
</ul>
</li>
<li><a href="#s.templates">Templates</a></li>
<li><a href="#s.functions">Functions</a></li>
<li>
<ul class="sectlevel2">
<li><a href="#_boolean">Boolean</a></li>
<li><a href="#_list">List</a></li>
<li><a href="#_string">String</a></li>
<li><a href="#_filters">Filters</a></li>
<li><a href="#_predicates">Predicates</a></li>
<li><a href="#_math">Math</a></li>
<li><a href="#_phase">Phase</a></li>
<li><a href="#_ironbee">IronBee</a></li>
<li><a href="#_development">Development</a></li>
<li><a href="#_templates">Templates</a></li>
</ul>
</li>
<li><a href="#_specific_advice">Specific Advice</a></li>
<li>
<ul class="sectlevel2">
<li><a href="#_phaseless_rules">Phaseless Rules</a></li>
<li><a href="#s.operator_and_foperator">Operator and FOperator</a></li>
<li><a href="#_short_circuited_boolean_functions">Short-Circuited Boolean Functions</a></li>
<li><a href="#_the_pushname_flatten_idiom">The PushName-Flatten Idiom</a></li>
<li><a href="#_interaction_with_actions_and_code_set_predicate_vars_code">Interaction with actions and <code>set_predicate_vars</code></a></li>
</ul>
</li>
<li><a href="#_tools">Tools</a></li>
<li>
<ul class="sectlevel2">
<li><a href="#_predicatetrace">PredicateTrace</a></li>
<li><a href="#_pp">PP</a></li>
<li><a href="#s.pp_dot">PP Dot</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>For an overview and discussion of the system, see <a href="introduction.html">introduction</a>.  For a comprehensive reference to the language, see <a href="reference.html">reference</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This document is intended as a tutorial and initial reference to orient rule writers to using Predicate.  Predicate is an alternative rule system for the IronBee web application firewall.  It is assumed that you are familiar with IronBee and web application firewalls.</p>
</div>
<div class="paragraph">
<p>Predicate associates a predicate <em>expression</em> with a rule and fires the rule if and only if the predicate expression evaluates to true.  In comparison to the default rule system, Predicate has superior support for composition and configuration time optimization; on the downside, it does not support rule ordering and can be unintuitive.</p>
</div>
<div class="paragraph">
<p>SExpressions (sexprs) are the underlying language of Predicate.  It is not expected that you, a rule writer, will write SExpressions directly.  However, you will see them in error messages and tools and is worthwhile to be familiar with them.  As such, for most Lua code in this document, I have added Lua comments containing the equivalent SExpression, e.g.,</p>
</div>
<div class="listingblock">
<div class="title">Example: Equivalent SExpression</div>
<div class="content">
<pre>P.Gt(1000, P.Length(P.Var('REQUEST_URI')))
-- (gt 1000 (length (var 'REQUEST_URI')))</pre>
</div>
</div>
<div class="paragraph">
<p>The second line is the S-Expression corresponding to the first line, prefixed with the Lua comment designator, <code>--</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_orientation">Orientation</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_terminology">Terminology</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">Top-Level Expression</dt>
<dd>
<p>An expression associated with a rule.  The rule will fire if and when the expression becomes truthy.</p>
</dd>
<dt class="hdlist1">Truthy</dt>
<dd>
<p>An expression or value that is interpreted as true.</p>
</dd>
<dt class="hdlist1">Falsy</dt>
<dd>
<p>An expression or value that is interpreted as false.</p>
</dd>
<dt class="hdlist1">Waggle</dt>
<dd>
<p>A Lua interface to writing IronBee rules.</p>
</dd>
<dt class="hdlist1">Frontend</dt>
<dd>
<p>A Lua interface to writing Predicate expressions.</p>
</dd>
<dt class="hdlist1">SExpr</dt>
<dd>
<p>The low level representation of Predicate expressions.</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_first_steps">First Steps</h3>
<div class="paragraph">
<p>Let&#8217;s begin with a series of basic examples.  Consider the following logic:</p>
</div>
<div class="quoteblock">
<blockquote>
If the URI of the request is really long, then &#8230;
</blockquote>
</div>
<div class="paragraph">
<p>Interpreting, &#8220;is really long&#8221; to mean &#8220;has a length greater than 1000&#8221;, we can write this in the frontend as:</p>
</div>
<div class="listingblock">
<div class="title">Example: First Steps 1</div>
<div class="content">
<pre>P.Gt(1000, P.Length(P.Var('REQUEST_URI')))
-- (gt 1000 (length (var 'REQUEST_URI')))</pre>
</div>
</div>
<div class="paragraph">
<p>This is Lua code.  <code>P.Gt()</code> is a Lua function that produces a <em>predicate object</em> from its arguments, which are in turn predicate objects (or Lua literals).  The Waggle <code>predicate()</code> directive understands predicate objects and turns them into sexprs to pass on to Predicate, e.g.,</p>
</div>
<div class="listingblock">
<div class="title">Example: Waggle Rule</div>
<div class="content">
<pre>Action("predicate_example", "1"):
	phase([[REQUEST_HEADER]]):
	action([[clipp_announce:predicate_example]]):
	predicate(P.Gt(1000, P.Length(P.Var('REQUEST_URI'))))</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Predicate is usually used with <code>Action</code> rather than <code>Rule</code> in waggle.  Using <code>Action</code> ensures that whether to fire the rule is entirely up to Predicate.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Predicate expressions are built up by composing <em>predicate functions</em> along with literals.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s extend our logic to:</p>
</div>
<div class="quoteblock">
<blockquote>
If the URI of the request is really long and the request is a GET request, then &#8230;
</blockquote>
</div>
<div class="listingblock">
<div class="title">Example: First Steps 2</div>
<div class="content">
<pre>P.And(
    P.Gt(1000, P.Length(P.Var('REQUEST_URI'))),
    P.Eq('GET', P.Var('REQUEST_METHOD'))
)
-- (and
--     (gt 1000 (length (var 'REQUEST_URI')))
--     (eq 'GET' (var 'REQUEST_METHOD'))
-- )</pre>
</div>
</div>
<div class="paragraph">
<p>The frontend provides some additional interfaces to more easily express certain patterns.  In particular, it allows using the <code>+</code> operator for logical AND.  This changes our expression to:</p>
</div>
<div class="listingblock">
<div class="title">Example: First Steps 3</div>
<div class="content">
<pre>  P.Gt(1000, P.Length(P.Var('REQUEST_URI')))
+ P.Eq('GET', P.Var('REQUEST_METHOD'))
-- (and
--     (gt 1000 (length (var 'REQUEST_URI')))
--     (eq 'GET' (var 'REQUEST_METHOD'))
-- )</pre>
</div>
</div>
<div class="paragraph">
<p>The frontend also allows us to use object method syntax, where the object is passed in to the function as the last argument:</p>
</div>
<div class="listingblock">
<div class="title">Example: First Steps 4</div>
<div class="content">
<pre>  P.Var('REQUEST_URI'):length():gt(1000)
+ P.Var('REQUEST_METHOD'):eq('GET')
-- (and
--     (gt 1000 (length (var 'REQUEST_URI')))
--     (eq 'GET' (var 'REQUEST_METHOD'))
-- )</pre>
</div>
</div>
<div class="paragraph">
<p>When and whether to use such shortcuts is a matter of style.  Use them if you believe they make the logic clearer.</p>
</div>
</div>
<div class="sect2">
<h3 id="_second_steps">Second Steps</h3>
<div class="paragraph">
<p>Let&#8217;s look for a suspicious filename in every parameter:</p>
</div>
<div class="listingblock">
<div class="title">Example: Second Steps 1</div>
<div class="content">
<pre>P.FOperator('rx', '/etc/(?:passwd|shadow)', P.Var('ARGS'))
-- (foperator 'rx' '/etc/(?:passwd|shadow)' (var 'ARGS'))</pre>
</div>
</div>
<div class="paragraph">
<p><code>P.FOperator()</code> is an example of using an IronBee operator.  IronBee operators are functions provided by modules that can be used by any rule system, not just Predicate.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
See <a href="#s.operator_and_foperator">Operator and FOperator</a> for discussion on why <code>P.FOperator()</code> is used here.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now let&#8217;s limit to only GET and POST requests:</p>
</div>
<div class="listingblock">
<div class="title">Example: Second Steps 2</div>
<div class="content">
<pre>P.And(
    P.FOperator('rx', '/etc/(?:passwd|shadow)', P.Var('ARGS')),
    P.Or(
        P.Eq('GET', P.Var('REQUEST_METHOD')),
        P.Eq('POST', P.Var('REQUEST_METHOD'))
    )
)
-- (and
--     (foperator 'rx' '/etc/(?:passwd|shadow)' (var 'ARGS'))
--     (or
--         (eq 'GET' (var 'REQUEST_METHOD'))
--         (eq 'POST' (var 'REQUEST_METHOD'))
--     )
-- )</pre>
</div>
</div>
<div class="paragraph">
<p>There is a shortcut for logical OR, <code>/</code>.  Using that and our other alternatives:</p>
</div>
<div class="listingblock">
<div class="title">Example: Second Steps 3</div>
<div class="content">
<pre>  P.Var('ARGS'):foperator('rx', '/etc/(?:passwd|shadow)')
+ (
      P.Var('REQUEST_METHOD'):eq('GET')
    / P.Var('REQUEST_METHOD'):eq('POST')
  )
-- (and
--     (foperator 'rx' '/etc/(?:passwd|shadow)' (var 'ARGS'))
--     (or
--         (eq 'GET' (var 'REQUEST_METHOD'))
--         (eq 'POST' (var 'REQUEST_METHOD'))
--     )
-- )</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="s.composition">Composition</h3>
<div class="paragraph">
<p>A primary motivation for Predicate is to allow easy composition of rule logic.  The previous examples have not directly taken advantage of that.  Since we are writing our Predicate expressions in Lua when can make use of Lua features such as variables and functions to compose logic.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s factor out some common pieces of logic, such as &#8220;is a GET request&#8221;:</p>
</div>
<div class="listingblock">
<div class="title">Example: <code>IsGet</code></div>
<div class="content">
<pre>local IsGet = P.Var('REQUEST_METHOD'):eq('GET')
-- (eq 'GET' (var 'REQUEST_METHOD))</pre>
</div>
</div>
<div class="paragraph">
<p>And &#8220;is a POST request&#8221;:</p>
</div>
<div class="listingblock">
<div class="title">Example: <code>IsPost</code></div>
<div class="content">
<pre>local IsPost = P.Var('REQUEST_METHOD'):eq('POST')
-- (eq 'POST' (var 'REQUEST_METHOD))</pre>
</div>
</div>
<div class="paragraph">
<p>The example from the previous section then becomes:</p>
</div>
<div class="listingblock">
<div class="title">Example: Composition</div>
<div class="content">
<pre>  P.Var('ARGS'):foperator('rx', '/etc/(?:passwd|shadow)')
+ (IsGet / IsPost)
-- (and
--     (foperator 'rx' '/etc/(?:passwd|shadow)' (var 'ARGS'))
--     (or
--         (eq 'GET' (var 'REQUEST_METHOD'))
--         (eq 'POST' (var 'REQUEST_METHOD'))
--     )
-- )</pre>
</div>
</div>
<div class="paragraph">
<p>Note how the use of intermediate Lua variables to hold pieces of expressions does not affect the resulting sexpr.  I.e., this sort of composition is at the Lua level and happens before conversion to an sexpr.  For a way to do composition post-sexpr, see <a href="#s.templates">Templates</a>.</p>
</div>
<div class="paragraph">
<p>We are not limited to variables.  Consider:</p>
</div>
<div class="quoteblock">
<blockquote>
Header X is longer than 1000 bytes.
</blockquote>
</div>
<div class="paragraph">
<p>First, let&#8217;s define a function to find the value of the &#8220;Header X&#8221;:</p>
</div>
<div class="listingblock">
<div class="title">Example: <code>RequestHeader</code></div>
<div class="content">
<pre>local function RequestHeader(which)
    return P.Sub(which, P.Var('REQUEST_HEADERS'))
end</pre>
</div>
</div>
<div class="paragraph">
<p>This function takes the name of a header and provides a predicate object representing the value of that header.  It uses a new function, <code>P.Sub()</code>, which is used to select a specific member from a collection.</p>
</div>
<div class="paragraph">
<p>We can now use <code>RequestHeader()</code> to define a notion of a long header:</p>
</div>
<div class="listingblock">
<div class="title">Example: <code>LongHeader</code></div>
<div class="content">
<pre>local function LongHeader(which)
    return RequestHeader(which):length():gt(1000)
end</pre>
</div>
</div>
<div class="paragraph">
<p>We can now use <code>LongHeader()</code> to express:</p>
</div>
<div class="quoteblock">
<blockquote>
The Host header is longer than 1000 bytes.
</blockquote>
</div>
<div class="listingblock">
<div class="title">Example: <code>LongHeader</code> usage</div>
<div class="content">
<pre>LongHeader('HOST')
-- (gt 1000 (length (sub 'Host' (var 'REQUEST_HEADERS))))</pre>
</div>
</div>
<div class="paragraph">
<p>There is additional value to reusing pieces of logic.  Predicate automatically detects any reused expressions across all Predicate expressions and only evaluates them once, reusing the result.  This reuse can provide significant performance benefits.</p>
</div>
</div>
<div class="sect2">
<h3 id="_configuration_time">Configuration Time</h3>
<div class="paragraph">
<p>IronBee operates at two different times.  At configuration time, it interprets its configuration and sets up any data structures it needs to evaluate traffic.  At runtime (also called evaluation time), it interprets web traffic, determines which rules should be fired (involves evaluating predicate expressions), and fires those rules.</p>
</div>
<div class="paragraph">
<p>When using Predicate, there is a further distinction to be made at configuration time.  There is computation that occurs in Lua and computation that occurs in Predicate.  In Lua, the Lua code is executed to produce predicate objects which are turned into sexprs.  Those sexprs are then passed to Predicate.  Predicate merges all sexprs together and, once it has everything, performs validation and optimization passes.</p>
</div>
<div class="paragraph">
<p>This division has a number of implications.  Two important ones are:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Some warnings and errors occur at the close of a configuration context and are in terms of sexprs rather than Lua code.  In most cases, the Lua file and line number are provided with the error message.</p>
</li>
<li>
<p>Since Lua based composition is performed in Lua, the resulting SExprs that are communicated to Predicate can become quite large.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The use of <a href="#s.templates">Templates</a> can alleviate both of these problems.</p>
</div>
<div class="paragraph">
<p>Many Predicate functions support configuration time evaluation if all of their arguments are known at configuration time.  For example, consider setting a policy variable in Lua:</p>
</div>
<div class="listingblock">
<div class="title">Example: Policy Variable</div>
<div class="content">
<pre>-- Change this to true to apply rule to Post requests.
local ApplyToPost = false</pre>
</div>
</div>
<div class="paragraph">
<p>And then using it in a predicate expression, where <code>something_complicated</code> is some complex logic:</p>
</div>
<div class="listingblock">
<div class="title">Example: Using a Policy Variable</div>
<div class="content">
<pre>(IsGet / (ApplyToPost + IsPost)) + something_complicated
-- (and
--   (or
--     (eq 'GET' (var 'REQUEST_METHOD'))
--     (and (false) (eq 'POST' (var 'REQUEST_METHOD')))
--   )
--   something_complicated
-- )</pre>
</div>
</div>
<div class="paragraph">
<p>Since <code>ApplyToPost</code> is false, this expressions will always be false, no matter what <code>something_complicated</code> turns out to be.  Predicate understands this and transforms the entire expression to false at configuration time. These transformations allows for easy configuration or customization of rules while paying the performance cost only once, at configuration time.</p>
</div>
</div>
<div class="sect2">
<h3 id="_expressions_and_the_dag">Expressions and the DAG</h3>
<div class="paragraph">
<p>Any predicate expression can be represented as a tree.  For example:</p>
</div>
<div class="listingblock">
<div class="title">Example: Expression 1</div>
<div class="content">
<pre>  P.Var('ARGS'):foperator('rx', '/etc/(?:passwd|shadow)')
+ (IsGet / IsPost)
-- (and
--     (foperator 'rx' '/etc/(?:passwd|shadow)' (var 'ARGS'))
--     (or
--         (eq 'GET' (var 'REQUEST_METHOD'))
--         (eq 'POST' (var 'REQUEST_METHOD'))
--     )
-- )</pre>
</div>
</div>
<div class="paragraph">
<p>Corresponds to:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="guide_1.png" alt="Expression 1 as Tree">
</div>
<div class="title">Figure 1. Expression 1 as Tree</div>
</div>
<div class="paragraph">
<p>(All of the images in this section were generated via the <a href="#s.pp_dot"><code>pp_dot</code></a> tool.)</p>
</div>
<div class="paragraph">
<p>The DAG (directed acyclic graph) is the heart of Predicate.  It is initially generated by taking the trees from the predicate expressions of every rule and merging common subtrees together.</p>
</div>
<div class="paragraph">
<p>For example, consider this expression/tree:</p>
</div>
<div class="listingblock">
<div class="title">Example: Expressions 2</div>
<div class="content">
<pre>  P.Gt(1000, P.Length(P.Var('REQUEST_URI')))
+ (IsGet / IsPost)
-- (and
--     (gt 1000 (length (var 'REQUEST_URI')))
--     (or
--         (eq 'GET' (var 'REQUEST_METHOD'))
--         (eq 'POST' (var 'REQUEST_METHOD'))
--     )
-- )</pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="guide_2.png" alt="Expression 2 as Tree">
</div>
<div class="title">Figure 2. Expression 2 as Tree</div>
</div>
<div class="paragraph">
<p>We can add both of these expressions to the DAG, merging common subtrees, to end up with:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="guide_3.png" alt="Expression 1 and 2 as DAG">
</div>
<div class="title">Figure 3. Expression 1 and 2 as DAG</div>
</div>
<div class="paragraph">
<p>Merging common subexpressions enables cross-expression optimization and result sharing.</p>
</div>
<div class="sect3">
<h4 id="_one_dag_per_context">One DAG per Context</h4>
<div class="paragraph">
<p>Every configuration context has its own DAG.  Each context also inherits any rules and associated predicate expressions from its parent context.  Having per-context DAGs allows for differing policy to simplify each DAG in different ways.</p>
</div>
</div>
<div class="sect3">
<h4 id="_dag_lifecycle">DAG Lifecycle</h4>
<div class="paragraph">
<p>A DAG goes through a sequence of changes once all expression trees are known.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>All expression trees are combined to create the initial DAG, merging any common subtrees.</p>
</li>
<li>
<p>A validation pass is performed, in which every node does a number of sanity checks.</p>
</li>
<li>
<p>A transformation pass is performed, in which every node is allowed to manipulate the DAG.  For example, <code>(not (true))</code> will transform into a falsy value.</p>
</li>
<li>
<p>Repeat step 3 until the DAG doesn&#8217;t change, i.e., there is nothing more to transform.</p>
</li>
<li>
<p>A final validation pass is performed.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>After this process completes, the DAG is fixed.  It will never again change in structure and can be used for evaluation.</p>
</div>
</div>
<div class="sect3">
<h4 id="_dag_evaluation">DAG Evaluation</h4>
<div class="paragraph">
<p>DAG Evaluation is the process by which the values of nodes in the DAG are determined.  When a node associated with a rule becomes truthy, that rule is fired.  A DAG is evaluated on a per-transaction basis.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_values">Values</h3>
<div class="paragraph">
<p>We have made it this far without actually worrying about what the value returned by a function is.  As an example of how values can be complex, consider the following expressions:</p>
</div>
<div class="listingblock">
<div class="title">Example: Expression</div>
<div class="content">
<pre>P.Var('ARGS'):sub('a'):length():gt(5)
-- (gt 5 (length (sub 'a' (var 'ARGS'))))</pre>
</div>
</div>
<div class="paragraph">
<p>And consider the expression in the context of the following request:</p>
</div>
<div class="listingblock">
<div class="title">Example: Request</div>
<div class="content">
<pre>GET /example?a=123&amp;a=123456</pre>
</div>
</div>
<div class="paragraph">
<p>Here there are two parameters (members of <code>ARGS</code>) named <code>a</code>, one of which is longer than 5 bytes and one of which is not.  How do we interpret the expression in this situation?</p>
</div>
<div class="paragraph">
<p>In a boolean sense, the expression is truthy and can accurately be interpreted as:</p>
</div>
<div class="quoteblock">
<blockquote>
Does any member of <code>ARGS</code> named <code>a</code> have length greater than 5.
</blockquote>
</div>
<div class="paragraph">
<p>As we will see, the actual value of the expression is:</p>
</div>
<div class="listingblock">
<div class="title">Example: Value</div>
<div class="content">
<pre>[a:'123456']</pre>
</div>
</div>
<div class="paragraph">
<p>The result of any expression, including any literal, is called a <em>Value</em>.  A Value is a name, a type, and a value.  Names are always strings.  At present, the possible types with their values are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">String</dt>
<dd>
<p>A sequence of bytes, possibly including NULs.</p>
</dd>
<dt class="hdlist1">Number</dt>
<dd>
<p>A signed integer.</p>
</dd>
<dt class="hdlist1">Float</dt>
<dd>
<p>A signed floating point.</p>
</dd>
<dt class="hdlist1">List</dt>
<dd>
<p>A list of Values.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>In addition, there is a not-a-value Value called <em>null</em> and written <code>:</code> (The null Value has no name or value).  In Lua, it is available as <code>P.Null</code>.</p>
</div>
<div class="paragraph">
<p>In Predicate, null and any empty list are falsy.  All other Values are truthy.</p>
</div>
<div class="paragraph">
<p>There is a subset of the sexpression grammar to describe values.  Lists are enclosed in brackets, and names, when present, are specified via <code>name:value</code>.  Here are some examples:</p>
</div>
<div class="listingblock">
<div class="title">Example: Literals</div>
<div class="content">
<pre>1.23
'Hello World'
['x' 'y' 'z']
named_list:[a:1 b:2 c:3]</pre>
</div>
</div>
<div class="paragraph">
<p>There are a few more complications.  Consider the expression:</p>
</div>
<div class="listingblock">
<div class="title">Example: Finished and Unfinished</div>
<div class="content">
<pre>P.Not(P.FOperator('rx' 'foo', P.Var('ARGS'))
-- (not (foperator 'rx' 'foo' (var 'ARGS')))</pre>
</div>
</div>
<div class="paragraph">
<p>Meaning</p>
</div>
<div class="quoteblock">
<blockquote>
There is no argument with value containing <code>foo</code>.
</blockquote>
</div>
<div class="paragraph">
<p>The <code>ARGS</code> collection begins each transaction empty, potentially grows after the request URI is parsed, and potentially grows again once the body is parsed.  Imagine we have seen the URI but not the body.  If an argument containing <code>foo</code> appears in the URI, then this expression must be falsy, but if it does not, we cannot yet say whether it is truthy or falsy.  Instead, we must wait for the request body to be parsed.</p>
</div>
<div class="paragraph">
<p>To accommodate <code>foo</code> appearing only in the body, Predicate allows list Values to grow.  The result of <code>P.Var('ARGS')</code> begins as an empty list and may grow later.  List Values are only allowed to grow, they may never shrink or change earlier elements.  A consequence of this is that expressions may change from falsy to truthy but never from truthy to falsy.  This allows Predicate to begin this expression as falsy and change it to truthy after the request body.</p>
</div>
<div class="paragraph">
<p>But if <code>foo</code> appears in the URI, we want to know that the expression is falsy immediately, if for no other reason than to not spend time evaluating it later.  To accommodate this, every node has a notion of finished or not.  Once a node is finished, it may not modify its list Value.</p>
</div>
<div class="paragraph">
<p>With this in hand, we can now describe how the expressions works:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>P.Var('ARGS')</code> begins empty and unfinished.  After the request URI is parsed, it may add any arguments in the request URI but stays unfinished.  After the request body is parsed, it may add any arguments in the request body and becomes finished, knowing that no more arguments can appear.</p>
</li>
<li>
<p><code>P.FOperator('rx', 'foo', ...)</code> begins by checking its last argument.  As that argument is an empty list, <code>P.FOperator()s</code> Value is an empty list.  As that argument is unfinished, <code>P.FOperator()</code> is unfinished.  When values are added to its last argument, it checks the new values and adds any that contain <code>foo</code> to its Value.  Only when its second argument becomes finished, does it also become finished.</p>
</li>
<li>
<p><code>P.Not(...)</code> begins by checking its argument.  As its argument is falsy and unfinished, <code>P.Not()</code> must be falsy and unfinished.  It must be falsy because its argument may become truthy in the future: if <code>P.Not()</code> start truthy, it would have to change to falsy at that point, but functions are not allowed to change from truthy to falsy.  <code>P.Not()</code> must remain falsy until it knows its result will not change, either when its argument becomes truthy (in which case, <code>P.Not()</code> knows itself will be falsy and can be finished) or when its argument becomes finished.  In the example, if an argument containing <code>foo</code> appears in the request URI, then the first argument becomes truthy and <code>P.Not()</code> can become finished and falsy.  If an argument containing <code>foo</code> never appears, that <code>P.Not()</code> can only become truthy and finished after its argument becomes falsy and finished; which happens after the request body.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These details can become complicated.  It works out that <code>P.Not()</code> (and its related functions such as <code>P.Nand()</code>) are the main case where these details matter.  In most other cases, it suffices to understand that if there are multiple values, a Predicate expression is truthy if it is &#8220;true&#8221; for any of the values.  See <a href="#s.functions">Functions</a> for additional discussion.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="s.templates">Templates</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Templates are a feature for doing simple substitutions in the backend.  They are similar to simple Lua functions, but doing the substitutions in the backend has several advantages, including:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Reduces initial sexpression length and complexity.  In large rule sets, this can have noticeable performance implications.  In all cases, it can simplify the pre-transformation DAG making it easier to understand.</p>
</li>
<li>
<p>Produces better error messages by allowing them to refer to the template name.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Consider the Lua functions from <a href="#s.composition">Composition</a>.</p>
</div>
<div class="listingblock">
<div class="title">Example: Functions from Composition</div>
<div class="content">
<pre>local function RequestHeader(which)
    return P.Sub(which, P.Var('REQUEST_HEADERS'))
end
local function LongHeader(which)
    return RequestHeader(which):length():gt(1000)
end</pre>
</div>
</div>
<div class="paragraph">
<p>These simply replace part of an expression with an argument (<code>which</code>).  That sort of direct substitution can be expressed via templates:</p>
</div>
<div class="listingblock">
<div class="title">Example: Templates</div>
<div class="content">
<pre>PUtil.Define('RequestHeader', ['which'],
    P.Sub(P.Ref('which'), P.Var('REQUEST_HEADERS'))
)
-- (sub (ref 'which') (var 'REQUEST_HEADERS'))
PUtil.Define('LongHeader', ['which'],
  P.RequestHeader(P.Ref('which')):length():gt(1000)
)
-- (gt 1000 (length (RequestHeader (ref 'which'))))

P.LongHeader('HOST')
-- (LongHeader 'HOST')</pre>
</div>
</div>
<div class="paragraph">
<p>The main limitation of templates is that they can only do simple substitutions.  Here is an example of a Lua function that has no easy template equivalent:</p>
</div>
<div class="listingblock">
<div class="title">Example: EtcFile</div>
<div class="content">
<pre>local function EtcFile(filename)
    return P.Rx('^/etc/' .. filename .. '$', P.Var('REQUEST_URI'))
end</pre>
</div>
</div>
<div class="paragraph">
<p><code>EtcFile</code> constructs a regexp string from an argument; a task easily done in Lua but difficult in Predicate.  <code>EtcFile</code> is best implemented as a Lua function, not as a template.</p>
</div>
<div class="paragraph">
<p>See <a href="reference.html">reference</a> and <a href="template.html">template</a> for additional discussion.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="s.functions">Functions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section provides an overview of the Predicate standard library.  For a complete description, see <a href="reference.html">reference</a>.  Also remember that any IronBee transformation or operator can be used in Predicate.</p>
</div>
<div class="paragraph">
<p>There are a few common concepts that tie Predicate functions together and provide for a consistent interface.   The most important of these concepts are <em>Primary</em>, <em>Map</em>, and <em>Filter</em>.</p>
</div>
<div class="paragraph">
<p>Primary functions take a single &#8220;primary&#8221; argument as input and use any other arguments as &#8220;configuration&#8221;.  For example, <code>P.Operator(op, parameter, input)</code> treats <code>input</code> as the primary argument and <code>op</code> and <code>parameter</code> as configuration: they inform how to process the primary argument.  In all cases, the primary argument is last.  This final position interacts well with the object method syntax, e.g.,</p>
</div>
<div class="listingblock">
<div class="title">Example: Object Method Syntax and Primary Arguments</div>
<div class="content">
<pre>P.Var('ARGS'):operator('rx', '(\w+)=(\w+)')
-- (operator 'rx' '(\w+)=(\w+)' (var 'ARGS'))</pre>
</div>
</div>
<div class="paragraph">
<p>Primary functions are null and unfinished until all their secondary arguments are finished (secondary arguments are often but not always literals).</p>
</div>
<div class="paragraph">
<p>Map functions are Primary functions that apply a subfunction to every subvalue of their primary argument.  The result of a Map function is the values of the subfunction.  If the primary argument is not a list, then they apply the subfunction to the primary argument.  For example:</p>
</div>
<div class="listingblock">
<div class="title">Example: Map Functions</div>
<div class="content">
<pre>P.Neg(2)
-- (neg 2)
-- Result: -2

P.Neg({1, 2, 3})
-- (neg [1 2 3])
-- Result: [-1 -2 -3]</pre>
</div>
</div>
<div class="paragraph">
<p>Filter functions are Primary functions that apply a subfunction to every subvalue.  The result of a Filter function is the inputs for which the subfunction is truthy.  If the primary argument is not a list, then a Filter function returns the primary argument if the subfunction is truthy for it and null otherwise.  For example:</p>
</div>
<div class="listingblock">
<div class="title">Example: Filter Functions</div>
<div class="content">
<pre>P.Eq(2, 2)
-- (eq 2 2)
-- Result: 2

P.Eq(2, 3)
-- (eq 2 3)
-- Result: :

P.Eq(2, {1, 2, 3, 2})
-- (eq 2 [1 2 3 2])
-- Result: [2 2]</pre>
</div>
</div>
<div class="paragraph">
<p>See <a href="reference.html">reference</a> for additional concepts and discussion.</p>
</div>
<div class="paragraph">
<p>The standard library is divided into several sublibraries.  These are each briefly described below and are completely described in <a href="reference.html">reference</a>.</p>
</div>
<div class="sect2">
<h3 id="_boolean">Boolean</h3>
<div class="paragraph">
<p>Predicate directly provides three basic boolean connectives: <code>and</code>, <code>or</code>, and <code>not</code>.  The frontend adds several others implemented in terms of them: <code>xor</code>, <code>nxor</code>, <code>nand</code>, and <code>nor</code>.  E.g.,</p>
</div>
<div class="listingblock">
<div class="title">Example: <code>P.Xor()</code></div>
<div class="content">
<pre>P.Xor(a, b)
-- (or (and a (not b)) (and (not a) b))</pre>
</div>
</div>
<div class="paragraph">
<p>The frontend also provides a variety of shortcuts:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>a + b</code> is equivalent to <code>P.And(a, b)</code>.</p>
</li>
<li>
<p><code>a / b</code> is equivalent to <code>P.Or(a, b)</code>.</p>
</li>
<li>
<p><code>-a</code> is equivalent to <code>P.Not(a)</code>.</p>
</li>
<li>
<p><code>a - b</code> is equivalent to <code>a + (-b)</code></p>
</li>
<li>
<p><code>P.Xor(a, b)</code> is equivalent to <code>(a - b) + (b - a)</code>.</p>
</li>
<li>
<p><code>a ^ b</code> is equivalent to <code>P.Xor(a, b)</code>.</p>
</li>
<li>
<p><code>P.Nand(a, b)</code> is equivalent to <code>-(a + b)</code>.</p>
</li>
<li>
<p><code>P.Nor(a, b)</code> is equivalent to <code>-(a / b)</code>.</p>
</li>
<li>
<p><code>P.Nxor(a, b)</code> is equivalent to <code>-(a ^ b)</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Finally, there are canonical constants for providing true and false values:</p>
</div>
<div class="listingblock">
<div class="title">Example: <code>P.True and P.False</code></div>
<div class="content">
<pre>P.True
-- (true)

P.False
-- (false)</pre>
</div>
</div>
<div class="paragraph">
<p>The expressions <code>(true)</code> and <code>(false)</code> produce canonical truthy and falsy values, respectively.  These are: <code>[:'']</code> for true, and <code>:</code> for false.</p>
</div>
<div class="paragraph">
<p>Finally, there is an if statement: <code>P.If(p, t, f)</code>, which takes the value of <code>t</code> if <code>p</code> is truthy and <code>f</code> if <code>p</code> is falsy.</p>
</div>
</div>
<div class="sect2">
<h3 id="_list">List</h3>
<div class="paragraph">
<p>Predicate provides a variety of functions for manipulating lists, including: manipulating names of elements, concatenation, construction, selecting specific elements, flattening lists of lists, and more.</p>
</div>
</div>
<div class="sect2">
<h3 id="_string">String</h3>
<div class="paragraph">
<p>Predicate provides a regexp based string replacement function and a length function.</p>
</div>
</div>
<div class="sect2">
<h3 id="_filters">Filters</h3>
<div class="paragraph">
<p>Predicate provides filters for all the user operations: equality, less than, etc.  It also provides filters for selecting by name.</p>
</div>
</div>
<div class="sect2">
<h3 id="_predicates">Predicates</h3>
<div class="paragraph">
<p>Predicates test arguments.  There are predicates for length, being finished, being a literal, and being a list.</p>
</div>
</div>
<div class="sect2">
<h3 id="_math">Math</h3>
<div class="paragraph">
<p>Predicate provides the usual arithmetic operations along with min and max.</p>
</div>
</div>
<div class="sect2">
<h3 id="_phase">Phase</h3>
<div class="paragraph">
<p>Predicate provides functions for carefully controlling how expressions interact with the current phase of evaluation.  These are rarely needed.</p>
</div>
</div>
<div class="sect2">
<h3 id="_ironbee">IronBee</h3>
<div class="paragraph">
<p>Predicate provides functions to access operators, transformations, and vars.  If the <code>constant</code> module is being used, a function for accessing constants is also available.</p>
</div>
</div>
<div class="sect2">
<h3 id="_development">Development</h3>
<div class="paragraph">
<p>Predicates provides functions for testing and expression development.  The most important for a rule writer is <code>P.P()</code>.</p>
</div>
<div class="paragraph">
<p><code>P.P()</code> takes one or more arguments.  Its result is always that of its final argument.  When evaluated, it outputs the value of all arguments to standard error.  This allows it to be used like a print statement inside an expression, e.g.,</p>
</div>
<div class="listingblock">
<div class="title">Example: <code>P.P()</code></div>
<div class="content">
<pre>P.P('Top Result = ', P.And(
    P.Gt(1000, P.Length(P.Var('REQUEST_URI'))),
    P.Eq('GET', P.P('REQUEST_METHOD = ', P.Var('REQUEST_METHOD')))
)
-- (p 'Top Result = ' (and
--     (gt 1000 (length (var 'REQUEST_URI')))
--     (eq 'GET' (p 'REQUEST_METHOD =  (var 'REQUEST_METHOD')))
-- ))</pre>
</div>
</div>
<div class="paragraph">
<p>When this expression is evaluated, the result of the expression as the whole and of <code>P.Var('REQUEST_METHOD')</code> will be written to standard error.</p>
</div>
<div class="paragraph">
<p>Be aware that <code>P.P()</code> only outputs when actually evaluated.  It may not be evaluated for various reasons including: a higher level boolean determined that it need not be; it was evaluated earlier and finished.</p>
</div>
</div>
<div class="sect2">
<h3 id="_templates">Templates</h3>
<div class="paragraph">
<p>Predicate provides the <code>P.Ref()</code> function for use in templates.  See <a href="#s.templates">Templates</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_specific_advice">Specific Advice</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section contains specific topics that have come up frequently.</p>
</div>
<div class="sect2">
<h3 id="_phaseless_rules">Phaseless Rules</h3>
<div class="paragraph">
<p>Predicate rules do not need to be tied to a specific phase.  If a phase for them is specified, they are evaluated only in that phase and executed if they are truthy in that phase.  If no phase is specified, they are evaluated
appropriately and executed at the earliest phase they are truthy in.</p>
</div>
</div>
<div class="sect2">
<h3 id="s.operator_and_foperator">Operator and FOperator</h3>
<div class="paragraph">
<p>IronBee operators take an input and produce two outputs:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A true or false value.</p>
</li>
<li>
<p>Optionally, a &#8220;capture collection&#8221;.  A capture collection is always either null or a list value.  Examples, including the captures from a regular expression match.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Predicate provides two functions to invoke operators, <code>P.Operator()</code> and <code>P.FOperator()</code>.  The both act like filters in that they only produce results for inputs for which the operator returns true.  They differ in the results they produce: <code>P.Operator()</code> produces the capture collections while <code>P.FOperator()</code> produces the passing inputs.</p>
</div>
<div class="paragraph">
<p>As a rule of thumb: If you don&#8217;t care about the capture collection, use <code>P.FOperator()</code>.</p>
</div>
<div class="paragraph">
<p>As with any map-like or filter function, both functions behave differently when their input is not a list Value.  In that case, if the operator returns false, both functions produce null.  If the operator returns true, <code>P.Operator()</code> returns the capture collection and <code>P.FOperator()</code> returns the input.</p>
</div>
<div class="paragraph">
<p>There is a rare edge case: if an input is null, the output of <code>P.FOperator()</code> is always null and the output of <code>P.Operator()</code> is likely always falsy (either <code>[]</code> or null).  In such a situation, it can be difficult to determine whether the operator returned true or false.  In the future, another operator function may be introduced which outputs true or false depending on what the operator returns.  Until then, if this situation matters to you, you must either explicitly test the input for nullness or use <code>P.Operator()</code> and explicitly check if the result is a (empty) list or null.</p>
</div>
</div>
<div class="sect2">
<h3 id="_short_circuited_boolean_functions">Short-Circuited Boolean Functions</h3>
<div class="paragraph">
<p>The logical &#8220;or&#8221; and &#8220;and&#8221; functions come in short-circuited and non-short-circuited flavors.  The short-circuited flavors are <code>P.OrSC()</code> and <code>P.AndSC()</code> and the non-short-circuited flavors are <code>P.And()</code> and <code>P.Or()</code>.</p>
</div>
<div class="paragraph">
<p>It may be tempting to always use the short-circuited flavors based on experience with other programming languages, but this temptation should be resisted.  The non-short-circuited flavors have a significant advantage in that they do not care about the order of the arguments.  For example, the following two expressions are equivalent, will merge in the DAG, and only be evaluated once:</p>
</div>
<div class="listingblock">
<div class="title">Example: <code>P.Or()</code></div>
<div class="content">
<pre>P.Or(x, y)
P.Or(y, x)</pre>
</div>
</div>
<div class="paragraph">
<p>As such, the non-short-circuited versions should be preferred except in cases when you know that evaluating a certain argument will be much more expensive than the others.  In such cases, consider using <code>P.If()</code> instead if it makes such dependence clearer, e.g.,</p>
</div>
<div class="listingblock">
<div class="title">Example: Short-Circuiting</div>
<div class="content">
<pre>-- Worst.
P.And(should_do_expensive_check, expensive_check)
-- Bad.
P.AndSC(should_do_expensive_check, expensive_check)
-- Better.
P.If(should_do_expensive_check, expensive_check)</pre>
</div>
</div>
<div class="paragraph">
<p>Finally, note that if <code>should_do_expensive_check</code> is known at configuration time, all of these will transform appropriately.  The only case where short-circuiting matters is when <code>should_do_expensive_check</code> is only known at run time and <code>expensive_check</code> is expensive relative to <code>should_do_expensive_check</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_pushname_flatten_idiom">The PushName-Flatten Idiom</h3>
<div class="paragraph">
<p>Consider applying a regular expression to a list of inputs:</p>
</div>
<div class="listingblock">
<div class="title">Example: Rx Captures&#8230;</div>
<div class="content">
<pre>P.Operator('rx', '\w{3}', [a:'123foo' b:'  bar-'])
-- (operator 'rx' '\w{3}' [a:'123foo' b:'  bar-'])
-- Result: [a:[0:'foo'] b:[0:'bar']</pre>
</div>
</div>
<div class="paragraph">
<p>You know the capture collections will be a single element and you&#8217;d rather interact with those elements than the entire collection.  You could flatten:</p>
</div>
<div class="listingblock">
<div class="title">Example: &#8230; with <code>P.Flatten()</code> &#8230;</div>
<div class="content">
<pre>P.Operator('rx', '\w{3}', [a:'123foo' b:'  bar-']):flatten()
-- (flatten (operator 'rx' '\w{3}' [a:'123foo' b:'  bar-']))
-- Result: [0:'foo' 0:'bar']</pre>
</div>
</div>
<div class="paragraph">
<p>This result has the values you want but has lost the names.  If you care about the names, you want to push them down first:</p>
</div>
<div class="listingblock">
<div class="title">Example: &#8230; And with <code>P.PushName()</code></div>
<div class="content">
<pre>P.Operator('rx', '\w{3}', [a:'123foo' b:'  bar-']):pushName():flatten()
-- (flatten (pushName (operator 'rx' '\w{3}' [a:'123foo' b:'  bar-'])))
-- Result: [a:'foo' b:'bar']</pre>
</div>
</div>
<div class="paragraph">
<p>This combination of <code>P.PushName()</code> and <code>P.Flatten()</code> occurs regularly and is the PushName-Flatten idiom.</p>
</div>
</div>
<div class="sect2">
<h3 id="_interaction_with_actions_and_code_set_predicate_vars_code">Interaction with actions and <code>set_predicate_vars</code></h3>
<div class="paragraph">
<p>A Predicate rule will fire if its expression is truthy.  If that expression is a list Value, it will fire once for every Value in the list.  This behavior matches the traditional IronBee rule system and allows for per-Value actions.</p>
</div>
<div class="paragraph">
<p>For per-value actions to be meaningful, they need to have access to each Value in turn.  This is accomplished via two vars: <code>PREDICATE_VALUE</code> and <code>PREDICATE_VALUE_NAME</code> which hold the value and name of each Value in turn.  For performance reasons, you must explicitly request that these vars be set by adding the <code>set_predicate_vars</code> action to your rule.  The vars will then be available for all <em>subsequent</em> actions.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tools">Tools</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_predicatetrace">PredicateTrace</h3>
<div class="paragraph">
<p>PredicateTrace is a feature of the IronBee Predicate Rules module.  When turned on, it outputs the DAG <em>with the value of each node</em> at the end of every phase.  It can be further be limited to only show the portions of the DAG that correspond to specific rules.</p>
</div>
<div class="paragraph">
<p>To use PredicateTrace add the <code>PredicateTrace</code> directive to your configuration file, specifying the trace file and rule ids to trace.  Run IronBee (e.g., with clipp) and then run <code>predicate/render_ptrace.rb</code> on the resulting trace file.  The output will be an HTML file.</p>
</div>
<div class="paragraph">
<p>See <a href="ptrace.pdf">ptrace.pdf</a> for details.</p>
</div>
</div>
<div class="sect2">
<h3 id="_pp">PP</h3>
<div class="paragraph">
<p>PP is a program (<code>predicate/pp.rb</code>) that can be run on a Waggle file containing Predicate rules.  It will extract all Predicate expressions from those rules, validate them, and produce an annotated HTML report that includes the sexprs, issues, and graphs.</p>
</div>
<div class="paragraph">
<p>See <a href="pp.pdf">pp.pdf</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="s.pp_dot">PP Dot</h3>
<div class="paragraph">
<p>PP Dot is a program (<code>predicate/pp_dot</code>) which PP uses to generate all its images.  It can also be used directly.  It takes sexpressions (possibly with labels) on standard in, one per line, and draws them according to the mode.  Current modes include:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Tree</dt>
<dd>
<p>Draw each sexpression as a tree.  Does no subtree merging, transformation, or validation.  Does not support labels or template definitions.</p>
</dd>
<dt class="hdlist1">Expr</dt>
<dd>
<p>Draw each sexpression as a graph.  Does subtree merging, transformation, and validation on a per-expression basis but not between expressions.  Does support template definitions.  Does not support labels.</p>
</dd>
<dt class="hdlist1">Graph</dt>
<dd>
<p>Combine all sexpressions into a graph.  Does subtree merging, transformation, and validation on the entire graph.  Does support labels and template definitions.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>If labels are supported they can be attached to sexpression by placing them before the sexpression on the line followed by a space.</p>
</div>
<div class="paragraph">
<p>Templates may be defined via a &#8220;Define&#8221; line, e.g.:</p>
</div>
<div class="listingblock">
<div class="title">Example: Define</div>
<div class="content">
<pre>Define LongHeader which,length (gt (ref 'length') (sub (ref 'which') (var 'REQUEST_HEADERS')))</pre>
</div>
</div>
<div class="paragraph">
<p>All drawings are done via <a href="http://www.graphviz.org">GraphViz</a> dot format.</p>
</div>
<div class="paragraph">
<p>As an example, for the input:</p>
</div>
<div class="listingblock">
<div class="title">Example: PP Dot</div>
<div class="content">
<pre>Define LongHeader which,length (gt (ref 'length') (sub (ref 'which') (var 'REQUEST_HEADERS')))
root1 (LongHeader 'Host' 1000)
root2 (and (LongHeader 'Content-Length' 10) (eq 'GET' (var 'REQUEST_METHOD')))</pre>
</div>
</div>
<div class="paragraph">
<p>The following two graphs are produced:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="guide_4.png" alt="Pre-Transformation Graph">
</div>
<div class="title">Figure 4. Pre-Transformation Graph</div>
</div>
<div class="imageblock">
<div class="content">
<img src="guide_5.png" alt="Post-Transformation Graph">
</div>
<div class="title">Figure 5. Post-Transformation Graph</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2014-06-26 10:01:31 CDT
</div>
</div>
</body>
</html>